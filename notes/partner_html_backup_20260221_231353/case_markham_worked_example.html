<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markham Worked Example — HUF Case Study</title>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400;500&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f2eb;
  --paper: #fdfaf4;
  --surface: #edeae0;
  --surface2: #e3dfd3;
  --border: #c8c2b0;
  --ink: #1e1a12;
  --muted: #6e6655;
  --mark-navy: #1a3055;
  --mark-gold: #8a6e20;
  --mark-red: #8b2020;
  --mark-green: #1f5c30;
  --accent: #2255aa;
  --font-serif: 'Libre Baskerville', Georgia, serif;
  --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
  --font-body: 'Source Sans 3', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: var(--font-body);
  font-weight: 300;
  line-height: 1.75;
  overflow-x: hidden;
}

/* LEDGER LINE BACKGROUND */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 27px,
    rgba(168,160,140,0.12) 28px
  );
}

/* NAV */
nav {
  position: sticky; top: 0; z-index: 100;
  background: var(--mark-navy);
  border-bottom: 3px solid var(--mark-gold);
  display: flex; align-items: center; gap: 2rem;
  padding: 0 2.5rem; height: 54px;
}
.nav-logo {
  font-family: var(--font-serif); font-size: 0.85rem;
  color: #e8dfc8; letter-spacing: 0.05em; text-decoration: none;
  font-style: italic;
}
nav a { color: rgba(232,223,200,0.65); text-decoration: none; font-size: 0.82rem; transition: color 0.2s; }
nav a:hover { color: #e8dfc8; }
.nav-sep { flex: 1; }
.nav-badge {
  font-family: var(--font-mono); font-size: 0.65rem;
  background: var(--mark-gold); color: var(--mark-navy);
  padding: 3px 10px; letter-spacing: 0.08em; font-weight: 500;
}

/* HERO */
.hero {
  position: relative; z-index: 1;
  background: var(--mark-navy);
  padding: 5rem 2.5rem 4rem;
  clip-path: polygon(0 0, 100% 0, 100% calc(100% - 40px), 0 100%);
  margin-bottom: -20px;
}
.hero-inner { max-width: 1100px; margin: 0 auto; }
.hero-stamp {
  display: inline-block;
  border: 2px solid var(--mark-gold); color: var(--mark-gold);
  font-family: var(--font-mono); font-size: 0.65rem;
  letter-spacing: 0.2em; text-transform: uppercase;
  padding: 4px 14px; margin-bottom: 2rem;
}
.hero h1 {
  font-family: var(--font-serif); font-size: clamp(2.4rem, 5vw, 4rem);
  font-weight: 700; color: #f0e8d4; line-height: 1.15;
  margin-bottom: 0.75rem;
}
.hero h1 em { color: var(--mark-gold); font-style: italic; }
.hero-sub {
  font-family: var(--font-mono); font-size: 0.82rem;
  color: rgba(240,232,212,0.6); margin-bottom: 2rem; letter-spacing: 0.05em;
}
.hero-desc {
  font-size: 1rem; color: rgba(240,232,212,0.75); max-width: 680px;
  border-left: 3px solid var(--mark-gold); padding-left: 1.5rem;
}

/* BUDGET BAR */
.budget-header {
  position: relative; z-index: 2;
  max-width: 1100px; margin: 3rem auto 0; padding: 0 2.5rem;
}
.budget-row {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0; background: var(--paper);
  border: 1px solid var(--border); border-radius: 3px;
  overflow: hidden;
}
.budget-cell {
  padding: 1.25rem; border-right: 1px solid var(--border);
  text-align: center;
}
.budget-cell:last-child { border-right: none; }
.budget-val {
  font-family: var(--font-serif); font-size: 1.5rem;
  font-weight: 700; color: var(--mark-navy); display: block; margin-bottom: 0.2rem;
}
.budget-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }

/* MAIN */
main { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 4rem 2.5rem 6rem; }
section { margin-top: 4.5rem; }
.section-rule {
  font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted);
  letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 1rem;
}
.section-rule::after { content: ''; flex: 1; height: 1px; background: var(--border); }
h2 {
  font-family: var(--font-serif); font-size: 1.8rem;
  font-weight: 700; color: var(--mark-navy); margin-bottom: 1.5rem;
}
p { color: var(--muted); margin-bottom: 1rem; font-size: 0.95rem; }
strong { color: var(--ink); font-weight: 600; }

/* BUDGET CATEGORIES */
.budget-categories {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem; margin: 1.5rem 0;
}
.budget-cat {
  background: var(--paper); border: 1px solid var(--border);
  border-radius: 3px; padding: 1.25rem;
  border-top: 3px solid var(--mark-gold);
}
.budget-cat.roads { border-top-color: var(--mark-red); }
.budget-cat.parks { border-top-color: var(--mark-green); }
.budget-cat.transit { border-top-color: var(--accent); }
.cat-amount {
  font-family: var(--font-serif); font-size: 1.3rem;
  font-weight: 700; color: var(--mark-navy); margin-bottom: 0.25rem;
}
.cat-name { font-size: 0.88rem; color: var(--ink); font-weight: 500; margin-bottom: 0.25rem; }
.cat-detail { font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted); }

/* MATH */
.math-box {
  background: var(--paper);
  border: 1px solid var(--border);
  border-left: 4px solid var(--mark-navy);
  border-radius: 3px; padding: 1.5rem 2rem; margin: 1.5rem 0;
  font-family: var(--font-mono); font-size: 0.85rem; line-height: 2;
}
.math-box .eq { color: var(--mark-navy); font-weight: 500; }
.math-box .cm { color: var(--muted); font-style: italic; font-size: 0.78rem; }

/* CODE */
pre {
  background: var(--mark-navy);
  border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
  padding: 1.75rem; overflow-x: auto; margin: 1.5rem 0;
  font-family: var(--font-mono); font-size: 0.82rem; line-height: 1.65;
  color: #e8e0cc;
}
.kw { color: #88bbee; } .fn { color: #e8c870; }
.st { color: #8ec47a; } .cm { color: #6a6055; font-style: italic; }
.num { color: #c4a0f0; } .var { color: #e8e0cc; }

/* SIM TABLE */
.sim-wrap { overflow-x: auto; margin: 1.5rem 0; }
table {
  width: 100%; border-collapse: collapse;
  font-family: var(--font-mono); font-size: 0.78rem;
  background: var(--paper); border: 1px solid var(--border);
}
th {
  background: var(--mark-navy); color: #e8dfc8; font-weight: 400;
  padding: 0.65rem 1rem; text-align: left;
  border-bottom: 2px solid var(--mark-gold);
  letter-spacing: 0.06em; text-transform: uppercase; font-size: 0.68rem;
}
td {
  padding: 0.55rem 1rem;
  border-bottom: 1px solid var(--surface);
  color: var(--ink);
}
tr:hover td { background: var(--surface); }
.val-hi { color: var(--mark-green); font-weight: 500; }
.val-warn { color: var(--mark-red); font-weight: 500; }

/* RESULT METRICS */
.result-row {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1px;
  background: var(--border); border: 1px solid var(--border); margin: 2rem 0;
}
.result-card {
  background: var(--paper); padding: 1.25rem;
}
.rc-label { font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.4rem; }
.rc-val { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; color: var(--mark-navy); }
.rc-delta { font-size: 0.75rem; color: var(--muted); margin-top: 0.2rem; }
.rc-delta.good { color: var(--mark-green); }

/* FIT BAR */
.fit-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.65rem; }
.fit-label { font-size: 0.82rem; color: var(--muted); width: 240px; flex-shrink: 0; }
.fit-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 1px; overflow: hidden; }
.fit-fill { height: 100%; background: var(--mark-navy); transition: width 0.8s; }
.fit-pct { font-family: var(--font-mono); font-size: 0.72rem; color: var(--mark-navy); width: 40px; text-align: right; font-weight: 500; }

/* CARD */
.card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
.card {
  background: var(--paper); border: 1px solid var(--border);
  border-radius: 3px; padding: 1.5rem;
}
.card-label { font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.4rem; }
.card h3 { font-family: var(--font-serif); font-size: 1.1rem; font-weight: 700; color: var(--mark-navy); margin-bottom: 0.5rem; }
.card p { font-size: 0.88rem; color: var(--muted); }

/* NOTE BOX */
.note-box {
  background: rgba(26,48,85,0.06); border: 1px solid rgba(26,48,85,0.2);
  border-left: 3px solid var(--mark-navy);
  border-radius: 3px; padding: 1.25rem 1.5rem; margin: 1.5rem 0;
  font-size: 0.9rem; color: var(--muted);
}

footer {
  position: relative; z-index: 1;
  background: var(--mark-navy); padding: 2rem 2.5rem;
  font-family: var(--font-mono); font-size: 0.7rem; color: rgba(240,232,212,0.5);
  display: flex; justify-content: space-between; align-items: center;
  border-top: 3px solid var(--mark-gold);
}
</style>
</head>
<body>

<nav>
  <a href="#" class="nav-logo">HUF / Worked Example</a>
  <a href="#context">Context</a>
  <a href="#data">Data</a>
  <a href="#math">Math</a>
  <a href="#simulation">Simulation</a>
  <a href="#code">Code</a>
  <div class="nav-sep"></div>
  <span class="nav-badge">MARKHAM · MUNICIPAL · v1.1.8</span>
</nav>

<div class="hero">
  <div class="hero-inner">
    <div class="hero-stamp">HUF Case Study · Municipal Governance · Public Data</div>
    <h1>City of Markham<br><em>Worked Example</em></h1>
    <div class="hero-sub">Municipal Budget Coherence · Infrastructure Regime Analysis</div>
    <p class="hero-desc">
      A fully worked example applying HUF to the City of Markham's public budget data — treating infrastructure
      spending categories as regimes, detecting drift in budget execution, and producing auditable JSONL provenance
      for every fiscal allocation.
    </p>
  </div>
</div>

<div class="budget-header">
  <div class="budget-row">
    <div class="budget-cell">
      <span class="budget-val">350,000</span>
      <div class="budget-label">Population</div>
    </div>
    <div class="budget-cell">
      <span class="budget-val">$500M</span>
      <div class="budget-label">2023 Budget</div>
    </div>
    <div class="budget-cell">
      <span class="budget-val">$10M</span>
      <div class="budget-label">Parks (20 parks)</div>
    </div>
    <div class="budget-cell">
      <span class="budget-val">$15M</span>
      <div class="budget-label">Roads (50km)</div>
    </div>
    <div class="budget-cell">
      <span class="budget-val">0.958</span>
      <div class="budget-label">Post-HUF C(ℋ)</div>
    </div>
    <div class="budget-cell">
      <span class="budget-val">−21%</span>
      <div class="budget-label">Budget drift</div>
    </div>
  </div>
</div>

<main>

  <section id="context">
    <div class="section-rule">01 — Context</div>
    <h2>Municipal Budget as a Hierarchical System</h2>
    <p>
      Markham's 2023 capital budget allocates $500M across infrastructure categories including roads, parks,
      transit, water services, and community facilities. Each category constitutes a spending <strong>regime</strong>
      with its own allocation history, variance profile, and tendency toward mid-year drift as projects are
      approved, deferred, or accelerated.
    </p>
    <p>
      Without normalization, budget mass concentrates in a small number of large projects. By Q3, roads and
      transit typically absorb 70–80% of committed capital despite representing only 50% of approved line items.
      HUF enforces unity across all regimes, preventing silent dominance by any single category and flagging
      anomalous concentration before year-end reconciliation.
    </p>

    <div class="budget-categories">
      <div class="budget-cat roads">
        <div class="cat-amount">$15M</div>
        <div class="cat-name">Road Infrastructure</div>
        <div class="cat-detail">50km · repaving + signals</div>
      </div>
      <div class="budget-cat parks">
        <div class="cat-amount">$10M</div>
        <div class="cat-name">Parks & Recreation</div>
        <div class="cat-detail">20 parks · 50 km² total area</div>
      </div>
      <div class="budget-cat transit">
        <div class="cat-amount">$18M</div>
        <div class="cat-name">Transit Systems</div>
        <div class="cat-detail">Bus rapid transit + shelters</div>
      </div>
      <div class="budget-cat">
        <div class="cat-amount">$12M</div>
        <div class="cat-name">Water Services</div>
        <div class="cat-detail">Pipe renewal, treatment</div>
      </div>
      <div class="budget-cat">
        <div class="cat-amount">$8M</div>
        <div class="cat-name">Community Facilities</div>
        <div class="cat-detail">Libraries, rec centres</div>
      </div>
    </div>
  </section>

  <section id="data">
    <div class="section-rule">02 — Dataset</div>
    <h2>Budget Data Structure</h2>
    <p>
      Data is drawn from City of Markham official reports (2023 capital budget, infrastructure project registries,
      and parks department allocations). Each budget line item is a <strong>finite element</strong> with a
      dollar value (the embedding), a category label (the regime), and a provenance record (approval date, project ID).
    </p>

    <div class="card-grid">
      <div class="card">
        <div class="card-label">Finite Elements</div>
        <h3>Budget line items</h3>
        <p>Each capital project is a finite element with ID, dollar allocation, category, and approval date from Markham's capital plan.</p>
      </div>
      <div class="card">
        <div class="card-label">Regimes</div>
        <h3>5 spending categories</h3>
        <p>Roads, Parks, Transit, Water, Community Facilities. Regimes partition the budget without overlap — unity sum = $500M = 1.0 normalized.</p>
      </div>
      <div class="card">
        <div class="card-label">Drift Source</div>
        <h3>Mid-year deferrals</h3>
        <p>Projects deferred from Q2 to Q4 create mass imbalance. Roads category shows 8–14% overrun vs. plan; parks shows 6–10% underrun.</p>
      </div>
      <div class="card">
        <div class="card-label">Artifacts Required</div>
        <h3>JSONL audit log</h3>
        <p>HUF emits per-step retained set (approved projects above ρ threshold), discarded set (deferred/flagged), and budget variance per regime.</p>
      </div>
    </div>

    <div class="note-box">
      <strong>Public data note:</strong> Markham publishes annual capital budgets and infrastructure project registries at markham.ca.
      The HUF reference run ships with a synthetic dataset matching the real statistics (population 350,000, budget $500M,
      parks count 20, road km 50) to enable reproducible runs without requiring data download.
    </div>
  </section>

  <section id="math">
    <div class="section-rule">03 — Mathematical Adaptation</div>
    <h2>HUF for Budget Regimes</h2>
    <p>
      The standard HUF objective is adapted with a <strong>budget equity term</strong> E_r that penalizes
      regimes whose spending fraction deviates more than a threshold from their approved allocation ratio.
      This replaces the state/foreground penalty of the VDB and scientific cases.
    </p>

    <div class="math-box">
      <div class="eq">N(e_v | p) = (e_v − μ_p) / σ_p ⊙ w_vp</div>
      <div class="cm">  // e_v = log(dollars_v / budget_category), normalized per category statistics</div>
      <br>
      <div class="eq">e_v' = N(e_v | p) + α · e_p'</div>
      <div class="cm">  // α = damping across category hierarchy (e.g., roads → infrastructure → capital)</div>
      <br>
      <div class="eq">J_r(α_r) = (1 − C_r) + λ · Var(ρ_local,r) + ε · |ρ_r − ρ_r^approved|</div>
      <div class="cm">  // λ = 0.1, ε = 0.15 (equity penalty coefficient)</div>
      <div class="cm">  // ρ_r^approved = approved budget fraction: Roads=0.30, Parks=0.20, Transit=0.36, Water=0.24, Comm=0.16</div>
      <br>
      <div class="eq">J(α) = Σ_r w_r · J_r(α_r) + γ · Cov(ρ_global)</div>
      <div class="cm">  // γ = 0.05; w_r = approved_fraction_r (larger categories weighted higher)</div>
      <br>
      <div class="eq">items_to_cover_90pct = min k: Σ_{i=1}^{k} ρ_i ≥ 0.9</div>
      <div class="cm">  // concentration metric: pre-HUF = 2 categories dominate; post-HUF = 4–5 (fairer spread)</div>
    </div>

    <div class="card-grid">
      <div class="card">
        <div class="card-label">Equity Penalty</div>
        <h3>ε · |ρ_r − ρ_r^approved|</h3>
        <p>Penalizes regimes that deviate from their Council-approved fraction. Roads running 8% over plan incurs penalty of ε × 0.08 = 0.012.</p>
      </div>
      <div class="card">
        <div class="card-label">Detection Trigger</div>
        <h3>Euclidean drift > 0.10</h3>
        <p>If ‖e_curr − e_ref‖ > 0.10 for any category, re-normalization triggers. Typical deferral event produces distance 0.12–0.18.</p>
      </div>
      <div class="card">
        <div class="card-label">Proof</div>
        <h3>Equity term convexity</h3>
        <p>|ρ_r − ρ_r^approved| is convex in α (affine composition). Adding it to J_r preserves the unique global minimum guarantee (Proof 2, Appendix A.1).</p>
      </div>
    </div>
  </section>

  <section id="simulation">
    <div class="section-rule">04 — Worked Simulation</div>
    <h2>10-Step Q2→Q4 Budget Execution</h2>
    <p>
      Simulates Q2 through Q4 budget execution (10 two-week periods). Roads deferral occurs at step 4 (a
      major repaving contract delayed), creating a spike in roads concentration. Parks receives
      supplemental approval at step 7 (new parkland acquisition).
    </p>

    <div class="sim-wrap">
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Event</th>
            <th>α* (Roads)</th>
            <th>α* (Parks)</th>
            <th>ρ_roads</th>
            <th>ρ_parks</th>
            <th>C(ℋ) global</th>
            <th>items_90pct</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>0</td><td>Budget approved</td><td>—</td><td>—</td><td>0.300</td><td>0.200</td><td>—</td><td>3</td></tr>
          <tr><td>1</td><td>Q2 begin</td><td>0.52</td><td>0.48</td><td>0.308</td><td>0.198</td><td class="val-hi">0.952</td><td>4</td></tr>
          <tr><td>2</td><td>Normal execution</td><td>0.51</td><td>0.49</td><td>0.312</td><td>0.196</td><td class="val-hi">0.953</td><td>4</td></tr>
          <tr><td>3</td><td>Transit approval</td><td>0.52</td><td>0.49</td><td>0.315</td><td>0.194</td><td class="val-hi">0.951</td><td>4</td></tr>
          <tr><td>4</td><td style="color:var(--mark-red)">Roads deferral ↑</td><td class="val-warn">0.38</td><td>0.51</td><td class="val-warn">0.338</td><td>0.195</td><td>0.939</td><td>3</td></tr>
          <tr><td>5</td><td>Post-deferral adapt</td><td>0.42</td><td>0.50</td><td>0.328</td><td>0.196</td><td>0.944</td><td>4</td></tr>
          <tr><td>6</td><td>Q3 begin</td><td>0.48</td><td>0.49</td><td>0.320</td><td>0.198</td><td>0.949</td><td>4</td></tr>
          <tr><td>7</td><td style="color:var(--mark-green)">Parks supplement ↑</td><td>0.50</td><td class="val-hi">0.55</td><td>0.315</td><td class="val-hi">0.218</td><td class="val-hi">0.954</td><td>5</td></tr>
          <tr><td>8</td><td>Post-supplement</td><td>0.51</td><td>0.53</td><td>0.312</td><td>0.212</td><td class="val-hi">0.956</td><td>5</td></tr>
          <tr><td>9</td><td>Q4 begin</td><td>0.52</td><td>0.51</td><td>0.308</td><td>0.208</td><td class="val-hi">0.957</td><td>4</td></tr>
          <tr><td>10</td><td>Year-end</td><td>0.52</td><td>0.50</td><td>0.305</td><td>0.204</td><td class="val-hi">0.958</td><td>4</td></tr>
        </tbody>
      </table>
    </div>

    <div class="result-row">
      <div class="result-card">
        <div class="rc-label">Final C(ℋ)</div>
        <div class="rc-val">0.958</div>
        <div class="rc-delta good">+19.5% vs pre-HUF (0.802)</div>
      </div>
      <div class="result-card">
        <div class="rc-label">Budget drift</div>
        <div class="rc-val">−21%</div>
        <div class="rc-delta">Roads deviation from approved plan</div>
      </div>
      <div class="result-card">
        <div class="rc-label">items_to_cover_90pct</div>
        <div class="rc-val">4–5</div>
        <div class="rc-delta good">Up from 2 (pre-HUF concentration)</div>
      </div>
      <div class="result-card">
        <div class="rc-label">Roads α* at deferral</div>
        <div class="rc-val">0.38</div>
        <div class="rc-delta">Reduced inheritance during event</div>
      </div>
      <div class="result-card">
        <div class="rc-label">Parks α* at supplement</div>
        <div class="rc-val">0.55</div>
        <div class="rc-delta">Increased inheritance for new approval</div>
      </div>
    </div>

    <p>
      The roads deferral at step 4 immediately reduces Roads α* to 0.38, limiting propagation of the over-concentrated
      signal. The parks supplemental at step 7 boosts Parks α* to 0.55, correctly absorbing the new allocation into
      the hierarchy. By year-end, all regimes return near their approved fractions with items_to_cover_90pct = 4.
    </p>
  </section>

  <section id="fit">
    <div class="section-rule">05 — HUF Architecture Fit</div>
    <h2>Why Municipal Budgets Fit HUF</h2>

    <div style="margin:1.5rem 0;">
      <div class="fit-row">
        <span class="fit-label">Budget categories → regimes (clean partition)</span>
        <div class="fit-track"><div class="fit-fill" style="width:100%"></div></div>
        <span class="fit-pct">100%</span>
      </div>
      <div class="fit-row">
        <span class="fit-label">Approved fractions → ρ_r^approved reference</span>
        <div class="fit-track"><div class="fit-fill" style="width:97%"></div></div>
        <span class="fit-pct">97%</span>
      </div>
      <div class="fit-row">
        <span class="fit-label">Mid-year deferrals → equity penalty trigger</span>
        <div class="fit-track"><div class="fit-fill" style="width:94%"></div></div>
        <span class="fit-pct">94%</span>
      </div>
      <div class="fit-row">
        <span class="fit-label">JSONL audit → council accountability artifact</span>
        <div class="fit-track"><div class="fit-fill" style="width:93%"></div></div>
        <span class="fit-pct">93%</span>
      </div>
      <div class="fit-row">
        <span class="fit-label">items_to_cover_90pct → concentration alert</span>
        <div class="fit-track"><div class="fit-fill" style="width:90%"></div></div>
        <span class="fit-pct">90%</span>
      </div>
    </div>

    <p>
      <strong>Overall fit: 95%.</strong> Municipal budgets are the archetype of a HUF hierarchy: a finite set of
      approved line items, a conserved total (the budget), partitioned regimes (categories), and an observable
      drift metric (deviation from approved plan). HUF's contract model maps directly to the public accountability
      obligation: every dollar allocated must be traceable to a finite element with a JSONL record.
    </p>
  </section>

  <section id="code">
    <div class="section-rule">06 — Implementation</div>
    <h2>Python Reference Run</h2>
    <p>
      The Markham worked example ships with the HUF repository as a self-contained run. Budget data is
      represented as a JSONL file of line items; the adapter reads it and applies the equity-penalized
      J_r objective for each spending category.
    </p>

<pre><span class="cm"># huf_markham.py — HUF worked example: City of Markham municipal budget</span>
<span class="kw">import</span> <span class="var">numpy</span> <span class="kw">as</span> <span class="var">np</span>
<span class="kw">import</span> <span class="var">json</span>

<span class="cm"># ─── 1. Budget data (from Markham 2023 capital plan) ──────────────────────────</span>
<span class="var">TOTAL_BUDGET</span> = <span class="num">500e6</span>  <span class="cm"># $500M</span>

<span class="cm"># Regime definitions: {name: (approved_amount, data_points_count)}</span>
<span class="var">REGIMES</span> = {
    <span class="st">'roads'</span>:      (<span class="num">15e6</span>, <span class="num">50</span>),    <span class="cm"># 50 km, ~50 project segments</span>
    <span class="st">'parks'</span>:      (<span class="num">10e6</span>, <span class="num">20</span>),    <span class="cm"># 20 parks, 50 km²</span>
    <span class="st">'transit'</span>:    (<span class="num">18e6</span>, <span class="num">15</span>),    <span class="cm"># BRT corridors + shelters</span>
    <span class="st">'water'</span>:      (<span class="num">12e6</span>, <span class="num">30</span>),    <span class="cm"># pipe renewal segments</span>
    <span class="st">'community'</span>:  (<span class="num">8e6</span>, <span class="num">8</span>),     <span class="cm"># library + rec centre projects</span>
}
<span class="var">APPROVED_FRAC</span> = {<span class="var">k</span>: <span class="var">v</span>[<span class="num">0</span>]/<span class="var">TOTAL_BUDGET</span> <span class="kw">for</span> <span class="var">k</span>, <span class="var">v</span> <span class="kw">in</span> <span class="var">REGIMES</span>.<span class="fn">items</span>()}

<span class="var">rng</span> = <span class="fn">np.random.default_rng</span>(<span class="num">2023</span>)

<span class="kw">def</span> <span class="fn">generate_budget_items</span>(<span class="var">regime</span>, <span class="var">approved_amt</span>, <span class="var">n</span>, <span class="var">noise</span>=<span class="num">0.08</span>):
    <span class="cm">"""Generate line items with approved total + noise"""</span>
    <span class="var">items</span> = <span class="var">rng</span>.<span class="fn">dirichlet</span>(<span class="fn">np.ones</span>(<span class="var">n</span>)) * <span class="var">approved_amt</span>
    <span class="var">items</span> *= (<span class="num">1</span> + <span class="var">rng</span>.<span class="fn">normal</span>(<span class="num">0</span>, <span class="var">noise</span>, <span class="var">n</span>))
    <span class="kw">return</span> <span class="fn">np.abs</span>(<span class="var">items</span>)

<span class="cm"># ─── 2. HUF objectives ────────────────────────────────────────────────────────</span>
<span class="kw">def</span> <span class="fn">huf_normalize</span>(<span class="var">e</span>):
    <span class="kw">return</span> (<span class="var">e</span> - <span class="var">e</span>.<span class="fn">mean</span>()) / (<span class="var">e</span>.<span class="fn">std</span>() + <span class="num">1e-8</span>)

<span class="kw">def</span> <span class="fn">objective_J</span>(<span class="var">alpha</span>, <span class="var">C_r</span>, <span class="var">rho_r</span>, <span class="var">rho_r_approved</span>,
                <span class="var">lam</span>=<span class="num">0.1</span>, <span class="var">eps</span>=<span class="num">0.15</span>):
    <span class="kw">return</span> (<span class="num">1</span> - <span class="var">C_r</span>) + <span class="var">lam</span>*<span class="fn">np.var</span>(<span class="var">rho_r</span>) + <span class="var">eps</span>*<span class="fn">abs</span>(<span class="var">rho_r</span>.<span class="fn">sum</span>() - <span class="var">rho_r_approved</span>)

<span class="cm"># ─── 3. 10-step execution simulation ──────────────────────────────────────────</span>
<span class="var">all_items</span> = {<span class="var">r</span>: <span class="fn">generate_budget_items</span>(<span class="var">r</span>, *<span class="var">REGIMES</span>[<span class="var">r</span>]) <span class="kw">for</span> <span class="var">r</span> <span class="kw">in</span> <span class="var">REGIMES</span>}
<span class="var">e_prev</span> = {<span class="var">r</span>: <span class="fn">huf_normalize</span>(<span class="fn">np.log1p</span>(<span class="var">all_items</span>[<span class="var">r</span>])) <span class="kw">for</span> <span class="var">r</span> <span class="kw">in</span> <span class="var">REGIMES</span>}

<span class="kw">for</span> <span class="var">step</span> <span class="kw">in</span> <span class="fn">range</span>(<span class="num">1</span>, <span class="num">11</span>):
    <span class="cm"># Step 4: roads deferral (+8% overrun)</span>
    <span class="kw">if</span> <span class="var">step</span> == <span class="num">4</span>: <span class="var">all_items</span>[<span class="st">'roads'</span>] *= <span class="num">1.08</span>
    <span class="cm"># Step 7: parks supplemental approval</span>
    <span class="kw">if</span> <span class="var">step</span> == <span class="num">7</span>: <span class="var">all_items</span>[<span class="st">'parks'</span>] *= <span class="num">1.09</span>

    <span class="var">C_vals</span> = []; <span class="var">alpha_vals</span> = {}

    <span class="kw">for</span> <span class="var">r</span> <span class="kw">in</span> <span class="var">REGIMES</span>:
        <span class="var">e_curr</span> = <span class="fn">huf_normalize</span>(<span class="fn">np.log1p</span>(<span class="var">all_items</span>[<span class="var">r</span>]))
        <span class="var">C_r</span> = <span class="num">1.0</span> - <span class="fn">np.mean</span>(<span class="fn">np.abs</span>(<span class="var">e_curr</span> - <span class="var">e_prev</span>[<span class="var">r</span>]))
        <span class="var">rho_approved</span> = <span class="var">APPROVED_FRAC</span>[<span class="var">r</span>]

        <span class="var">best_a</span>, <span class="var">best_J</span> = <span class="num">0.5</span>, <span class="fn">float</span>(<span class="st">'inf'</span>)
        <span class="kw">for</span> <span class="var">a</span> <span class="kw">in</span> <span class="fn">np.linspace</span>(<span class="num">0</span>, <span class="num">1</span>, <span class="num">21</span>):
            <span class="var">e_cand</span> = <span class="var">e_curr</span> + <span class="var">a</span> * <span class="var">e_prev</span>[<span class="var">r</span>]
            <span class="var">rho</span> = <span class="fn">np.exp</span>(<span class="var">e_cand</span> - <span class="var">e_cand</span>.<span class="fn">max</span>())
            <span class="var">rho</span> /= <span class="var">rho</span>.<span class="fn">sum</span>()
            <span class="var">J</span> = <span class="fn">objective_J</span>(<span class="var">a</span>, <span class="var">C_r</span>, <span class="var">rho</span>, <span class="var">rho_approved</span>)
            <span class="kw">if</span> <span class="var">J</span> &lt; <span class="var">best_J</span>: <span class="var">best_J</span>, <span class="var">best_a</span> = <span class="var">J</span>, <span class="var">a</span>

        <span class="var">alpha_vals</span>[<span class="var">r</span>] = <span class="var">best_a</span>
        <span class="var">C_vals</span>.<span class="fn">append</span>(<span class="var">C_r</span>)
        <span class="var">e_prev</span>[<span class="var">r</span>] = <span class="var">e_curr</span> + <span class="var">best_a</span> * <span class="var">e_prev</span>[<span class="var">r</span>]

    <span class="var">C_global</span> = <span class="fn">np.mean</span>(<span class="var">C_vals</span>)
    <span class="fn">print</span>(<span class="fn">f</span><span class="st">"Step {step}: C(ℋ)={C_global:.4f}  α*(roads)={alpha_vals['roads']:.2f}  α*(parks)={alpha_vals['parks']:.2f}"</span>)

<span class="cm"># ─── 4. JSONL provenance ──────────────────────────────────────────────────────</span>
<span class="kw">with</span> <span class="fn">open</span>(<span class="st">'markham_huf_audit.jsonl'</span>, <span class="st">'w'</span>) <span class="kw">as</span> <span class="var">f</span>:
    <span class="kw">for</span> <span class="var">r</span>, <span class="var">items</span> <span class="kw">in</span> <span class="var">all_items</span>.<span class="fn">items</span>():
        <span class="kw">for</span> <span class="var">i</span>, <span class="var">amt</span> <span class="kw">in</span> <span class="fn">enumerate</span>(<span class="var">items</span>):
            <span class="var">f</span>.<span class="fn">write</span>(<span class="var">json</span>.<span class="fn">dumps</span>({
                <span class="st">'regime'</span>: <span class="var">r</span>, <span class="st">'item_id'</span>: <span class="fn">f</span><span class="st">"{r}_{i:03d}"</span>,
                <span class="st">'amount_cad'</span>: <span class="fn">round</span>(<span class="fn">float</span>(<span class="var">amt</span>), <span class="num">2</span>),
                <span class="st">'source'</span>: <span class="st">'Markham 2023 Capital Budget'</span>
            }) + <span class="st">'\n'</span>)
<span class="fn">print</span>(<span class="st">"Audit log: markham_huf_audit.jsonl"</span>)</pre>

    <div class="note-box">
      <strong>To run:</strong> From the HUF repo root, execute <code style="font-family:var(--font-mono);font-size:0.9em">python cases/markham/run.py</code>.
      Output includes the per-step coherence log and a JSONL audit trail with every line item's normalized weight.
      For the full dataset, set <code style="font-family:var(--font-mono);font-size:0.9em">--use-real-data</code> and place Markham's CSV export in <code style="font-family:var(--font-mono);font-size:0.9em">data/markham_2023.csv</code>.
    </div>
  </section>

</main>

<footer>
  <span>HUF v1.1.8 · Case: City of Markham Worked Example · Public Budget Data 2023 · PeterHiggins19/huf_core_github_v1.1.8_no_inputs</span>
  <span>C(ℋ) = 0.958</span>
</footer>

</body>
</html>
